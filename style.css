// assets/js/main.js
(() => {
  // Helpers
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  /* -------------------------
     THEME TOGGLE
     - stores choice in localStorage
  -------------------------*/
  const themeToggle = document.getElementById('theme-toggle');
  const applyTheme = (t) => {
    if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
    else document.documentElement.removeAttribute('data-theme');
    if (themeToggle) themeToggle.textContent = (t === 'light') ? 'â˜€ï¸' : 'ðŸŒ™';
  };
  const stored = localStorage.getItem('kld-theme');
  applyTheme(stored || 'dark');
  if (themeToggle) themeToggle.addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    applyTheme(next === 'light' ? 'light' : 'dark');
    localStorage.setItem('kld-theme', next === 'light' ? 'light' : 'dark');
  });

  /* -------------------------
     PRELOADER + PARTICLES SYNC
     - waits for custom 'particlesReady' OR canvas fallback
  -------------------------*/
  const preloader = $('#preloader');
  const hidePreloader = () => {
    if (!preloader) return;
    preloader.classList.add('hidden');
    setTimeout(()=> {
      if (preloader && preloader.parentNode) preloader.parentNode.removeChild(preloader);
    }, 600);
  };

  // Listen for custom event 'particlesReady' (if your particles.js dispatches it)
  let particlesFired = false;
  document.addEventListener('particlesReady', () => {
    particlesFired = true;
    setTimeout(hidePreloader, 220); // short delay for smooth visuals
    document.body.classList.add('page-loaded');
    revealFaders();
  });

  // fallback: detect canvas in #particles-js and proceed
  const fallbackStart = () => {
    const el = document.querySelector('#particles-js canvas');
    if (el && !particlesFired) {
      particlesFired = true;
      setTimeout(hidePreloader, 300);
      document.body.classList.add('page-loaded');
      revealFaders();
    }
  };

  // Fallback timeout (in case particles never initialize)
  const fallbackTimeout = setTimeout(() => {
    if (!particlesFired) {
      particlesFired = true;
      hidePreloader();
      document.body.classList.add('page-loaded');
      revealFaders();
    }
  }, 4000);

  // Try a couple times to find canvas quickly
  const tryCanvas = setInterval(() => {
    fallbackStart();
    if (particlesFired) clearInterval(tryCanvas);
  }, 300);

  /* -------------------------
     MENU / SIDEBAR / NAV
  -------------------------*/
  const mobileToggle = $('.menu-toggle');
  const navLinks = $$('.nav-links a');
  if (mobileToggle) {
    mobileToggle.addEventListener('click', () => {
      const nav = document.querySelector('.nav-links');
      nav && nav.classList.toggle('show');
      mobileToggle.classList.toggle('active');
    });
  }

  // Sidebar service submenu wiring
  document.querySelectorAll('.sidebar .has-sub > a').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      a.parentElement.classList.toggle('open');
    });
  });

  // Ensure top links scroll smoothly
  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', (e) => {
      const target = a.getAttribute('href');
      if (!target || target === '#') return;
      // If it's link to a local section
      if (target.startsWith('#') && document.querySelector(target)) {
        e.preventDefault();
        document.querySelector(target).scrollIntoView({ behavior: 'smooth', block: 'start' });
        // close mobile nav if open
        const nav = document.querySelector('.nav-links.show');
        nav && nav.classList.remove('show');
      } else {
        // external or folder link: allow default navigation
      }
    });
  });

  /* -------------------------
     REVEAL ANIMATIONS ON SCROLL
  -------------------------*/
  const faders = Array.from(document.querySelectorAll('.fade-in'));
  function revealFaders(){
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries, obs) => {
        entries.forEach(en => {
          if (en.isIntersecting) {
            en.target.classList.add('visible');
            obs.unobserve(en.target);
          }
        });
      }, { threshold: 0.18 });
      faders.forEach(f => io.observe(f));
    } else {
      // no IO fallback
      faders.forEach(f => f.classList.add('visible'));
    }
  }
  // Call reveal if particles already fired (maybe page loaded instantly)
  if (document.body.classList.contains('page-loaded')) revealFaders();

  /* -------------------------
     Service modal open (uses service card anchor)
  -------------------------*/
  function openServiceModal(name, desc){
    const modal = $('#serviceModal');
    if (!modal) return;
    const t = modal.querySelector('#modalTitle');
    const d = modal.querySelector('#modalDesc');
    t && (t.textContent = name);
    d && (d.textContent = desc);
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }
  const serviceLinks = $$('.service a');
  serviceLinks.forEach(a => {
    a.addEventListener('click', e => {
      // If link points to service folder (e.g. services/website/) allow navigation
      const href = a.getAttribute('href')||'';
      if (href && (href.startsWith('services/'))) {
        return; // let it navigate
      }
      // otherwise show modal with info (progressive enhancement)
      e.preventDefault();
      const card = a.closest('.service');
      const name = card ? (card.querySelector('h4') && card.querySelector('h4').textContent) : 'Service';
      const desc = card ? (card.querySelector('p') && card.querySelector('p').textContent) : '';
      openServiceModal(name, desc);
    });
  });

  // modal close
  document.addEventListener('click', (e) => {
    if (e.target.matches('.modal-close') || e.target.matches('.modal.show')) {
      const m = document.querySelector('.modal.show');
      if (m) {
        m.classList.remove('show');
        m.setAttribute('aria-hidden','true');
      }
    }
  });

  /* -------------------------
     Pricing buttons / CTA wiring
  -------------------------*/
  $$('#bookBasic, #bookPro, #bookPremium').forEach(btn => {
    if (!btn) return;
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      // prefill message to WhatsApp or open contact
      const name = encodeURIComponent(btn.closest('.card')?.querySelector('h4')?.textContent || 'Service Booking');
      const url = `https://wa.me/27658772518?text=I%20want%20to%20book:%20${name}`;
      window.open(url, '_blank');
    });
  });

  /* -------------------------
     Contact form: open whatsapp & post to Formspree (defensive)
  -------------------------*/
  const contactForm = document.querySelector('.contact-form');
  if (contactForm) {
    contactForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const fd = new FormData(contactForm);
      const name = fd.get('name') || 'Client';
      const email = fd.get('email') || '';
      const message = fd.get('message') || 'Hello';
      // open whatsapp quickly
      const wp = `https://wa.me/27658772518?text=${encodeURIComponent(`Hi, I'm ${name}. ${message} (Email: ${email})`)}`;
      window.open(wp, '_blank');

      // send to Formspree (non-blocking)
      try {
        await fetch(contactForm.action, { method:'POST', body: fd, headers:{ 'Accept':'application/json' }});
      } catch(e){ /* ignore network errors; whatsapp opened already */ }
      contactForm.reset();
    });
  }

  /* -------------------------
     small accessibility helper: keyboard focus visible
  -------------------------*/
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') document.documentElement.classList.add('user-tab');
  });

  /* -------------------------
     Expose for debug
  -------------------------*/
  window.KL = { openServiceModal, hidePreloader };

})();
